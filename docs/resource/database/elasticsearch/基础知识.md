[转自](!https://zq99299.github.io/note-book/elasticsearch-core/)

## core

* 全文搜索, 倒排索引
* Lucene
* Elasticsearch
  * 自动维护数据的分布到多个节点的索引建立、检索请求分布到多个节点的执行
  * 自动维护数据的冗余副本，保证一些机器宕机了，不会丢失任何数据
  * 封装了更多的高级功能, 复杂搜索, 聚合分析全文检索，同义词处理，相关度排名，复杂数据分析，海量数据的近实时处理, 基于地理位置搜索
  * 支持PB级数据
  * 作为传统数据库的补充, 提供了数据库所不能提供的很多功能

https://uzshare.com/view/822075


## 入门

* 面向文档的数据格式

### 集群管理
1. 快速查看集群健康状况
   * ```
     GET /_cat/health?v
     参数v: 显示标题头
     unassign：未分配数量
     active_shards_percent：可用 shards 百分比
     ```
    * status 状态
      * green：每个索引的 primary shard 和 replica shard 都是 active 状态的
      * yellow：每个索引的 primary shard 都是 active 状态的，但是部分 replica shard 不是 active 状态，处于不可用的状态
      * red：不是所有索引的 primary shard 都是 active 状态的，部分索引有数据丢失了
2. 查看集群索引
   * ```
    GET /_cat/indices?v
    pri 默认是 5 个，rep 默认是 1 个
     ```

### CRUD
1. 创建索引
  * ```
    PUT test_index
    {
      "mappings": {
        "properties" : {
          "create_time" : {
            "type":   "date",
            "format": "yyyy-MM-dd HH:mm:ss"
            },
          "gender" : {
            "type" : "long"
          },
          "id" : {
            "type" : "long"
          },
          "name" : {
            "type" : "text",
            "fields" : {
              "keyword" : {
                "type" : "keyword",
                "ignore_above" : 256
              }
            }
          }
        }
      }
    }
    ```

2. 删除索引
   * ```
      DELETE /test_index?pretty
     ```
3. 新增数据
   * ```
      PUT /user_test/_doc/1
      {
        "create_time": "2020-05-30 12:26:25"
      }

      *** resp ***

      {
        "_index" : "test_index",
        "_type" : "_doc",
        "_id" : "4005",  # 数据版本号
        "_version" : 1,
        "result" : "created",
        "_shards" : {
          "total" : 2,  # 总的要写的分片数量
          "successful" : 2,
          "failed" : 0
        },
        "_seq_no" : 6,
        "_primary_term" : 1
      }
     ```

4. 查询数据
   * ```
      GET /user_test/_search
      {
        "query": {
          "match_all": {}
        }
      }
     ```
5. 替换数据
   * ```
      PUT /user_test/_doc/4005
      {
        "create_time": "2020-05-30 14:26:25"
      }
     ```
    * 替换_id 为4005的所有数据
6. 更新数据
   * ```
      POST /user_test/_update/2119
      {
        "doc": {
          "name": "update name"
        }
      }
     ```
7. 删除文档
   * ```
      POST /user_test/_update/2119
      {
        "doc": {
          "name": "update name"
        }
      }
     ```

### query DSL(Domain Specified Language，特定领域的语言)
1. 查询所有
   * ```
      GET /user_test/_search
      {
        "query": {
          "match_all": {}
        }
      }
     ```
    * 响应
      ```
      {
        "took" : 2,
        "timed_out" : false,
        "_shards" : {
          "total" : 1,
          "successful" : 1,
          "skipped" : 0,
          "failed" : 0
        },
        "hits" : {
          "total" : {
            "value" : 10000,
            "relation" : "gte"
          },
          "max_score" : 1.0,
          "hits" : [
            {
              "_index" : "user_test",
              "_type" : "_doc",
              "_id" : "2219",
              "_score" : 1.0,
              "_source" : {
                "name" : "aaa",
                "gender" : 1,
                "state" : 1,
                "create_time" : "2015-02-05T18:29:50.068955",
                "id" : 2219
              }
            }
          ]
        }
      }
      ```
      * took: 查询时间
      * timed_out: 是否超时
      * _shards: 查询分片信息
      * hits.total: 查询结果数量
      * hits.max_score: 最高相关度
      * hits.hits: 匹配到的document list

2. 条件查询
   * 根据名称查询, 并且根据时间降序
   * ```
      GET user_test/_search
      {"query": {
            "bool": {
                "filter": {
                    "range": {
                        "create_time": {
                          "lt": "2020-07-10T12:24:00.00"
                        }
                    }
                }
            }
        },
        "sort": { "create_time": { "order": "desc" }},
        "size": 100
      }

     ```
3. 分页查询
   * from: 表示从第几条数据开始, 而不是页数
   * ```
      GET user_test/_search
      {"query": {
            "bool": {
                "filter": {
                    "range": {
                        "create_time": {
                          "lt": "2020-07-10T12:24:00.00"
                        }
                    }
                }
            }
        },
        "sort": { "create_time": { "order": "desc" }},
        "size": 1,
        "from": 2
      }

     ```
4. 限制返回字段
   * ```
      GET /user_test/_search
      {
        "query": {
          "match_all": {}
        },
        "_source": ["name","create_time"]
      }
     ```
5. query filter
   * ```
      GET /user_test/_search
      {
        "query": {
          "match_all": {}
        },
        "_source": ["name","create_time"]
      }
     ```
6. full-text search
7. 短语搜索(match_phrase)
8. 高亮搜索结果
   * ```
      GET /user_test/_search
      {
          "query" : {
              "match_phrase" : {
                  "name" : "thanks"
              }
          },
          "highlight": {
            "fields": {
              "name": {}
            }
          }
      }
     ```


### 聚合分析
1. 语法
   ```
   GET /user_test/_search
    {
      "aggs": {
        "NAME": {
          "AGG_TYPE": {}
        }
      }
    }
   ```
   * aggs: 聚合函数
   * NAME: 命名
   * AGG_TYPE: 聚合类型: terms/ avg
2. 聚合
   * ```
      GET /user_test/_search
      {
        "aggs": {
          "group_by_gender": {
            "terms": {
              "field": "gender"
            }
          }
        },
        "size": 0
      }

      ----------------------------------------------------------
      响应
      {
        "took" : 164,
        "timed_out" : false,
        "_shards" : {
          "total" : 1,
          "successful" : 1,
          "skipped" : 0,
          "failed" : 0
        },
        "hits" : {
          "total" : {
            "value" : 10000,
            "relation" : "gte"
          },
          "max_score" : null,
          "hits" : [ ]
        },
        "aggregations" : {
          "group_by_gender" : {
            "doc_count_error_upper_bound" : 0,
            "sum_other_doc_count" : 0,
            "buckets" : [
              {
                "key" : 1,
                "doc_count" : 46630
              },
              {
                "key" : 2,
                "doc_count" : 40823
              },
              {
                "key" : 0,
                "doc_count" : 12547
              }
            ]
          }
        }
      }

     ```
    * size: 控制响应中hits.hits 中的数据
3. 先搜索, 再聚合
4. 嵌套聚合
5. 多次嵌套(下钻操作)


## es 集群剖析
1. 对复杂分布式机制的透明隐藏特性
   1. 分片机制
   2. 集群发现机制
   3. shard 负载均衡
      1. 自动分配shard
      2. 集群扩容, shard重新分配
      3. 增加减少节点是的数据 re balance
2. master节点
   1. 管理es集群元数据, 自动选举
   2. 节点对等: master 节点不承载所有的请求，所以不存在单节点瓶颈
   * ```
      
     ```
   * ```
      
     ```




### fielddata
circuit_breaking_exception
https://blog.csdn.net/u014017121/article/details/70312784
https://www.elastic.co/guide/cn/elasticsearch/guide/current/_limiting_memory_usage.html