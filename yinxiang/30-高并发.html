<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content="Evernote Mac 9.4.0 (460661)"/><meta name="author" content="1404001663@qq.com"/><meta name="created" content="2018-08-31 03:59:44 +0000"/><meta name="source" content="desktop.win"/><meta name="source-application" content="yinxiang.win32"/><meta name="source-url" content="https://blog.csdn.net/u012373815/article/details/71435926"/><meta name="updated" content="2020-04-28 02:40:07 +0000"/><title>30-高并发</title></head><body><div><ol><li><div><span style="font-size: 10pt;">常见解决方案</span></div></li><ol><li><div><span style="font-size: 10pt;">技术层面</span></div></li><ol><li><div><span style="font-size: 10pt;">应用和静态资源（图片，视频，js，css）分离</span></div></li><li><div><span style="font-size: 10pt;">缓存，和静态化</span></div></li><ol><li><div><span style="letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><span style="font-size: 10pt; color: rgb(79, 79, 79); font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif, SimHei, SimSun; font-variant-caps: normal; font-variant-ligatures: normal;">将数据库中获取的结果暂时保存起来，下次需要时直接提取</span></span></div></li><li><div><span style="letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><span style="font-size: 10pt; color: rgb(79, 79, 79); font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif, SimHei, SimSun; font-variant-caps: normal; font-variant-ligatures: normal;">页面静态化是将程序最后生成的页面保存起来</span></span></div></li></ol><li><div><span style="font-size: 10pt;">数据库优化</span></div></li><ol><li><div><span style="font-size: 10pt;">表结构优化</span></div></li><li><div><span style="font-size: 10pt;">索引优化</span></div></li><li><div><span style="font-size: 10pt;">SQL语句优化</span></div></li><li><div><span style="font-size: 10pt;">分区分表</span></div></li><li><div><span style="font-size: 10pt;">分离活跃数据，或者叫冷热分离</span></div></li></ol></ol><li><div><span style="font-size: 10pt;">设备层面</span></div></li><ol><li><div><span style="font-size: 10pt;">设备升级</span></div></li><li><div><span style="font-size: 10pt;">集群和分布式</span></div></li><ol><li><div><span style="letter-spacing: 0.2px; orphans: 3; text-indent: 0px; text-transform: none; white-space: normal; widows: 3; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><span style="font-size: 10pt; color: rgb(51, 51, 51); font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">集群是每台服务器都具有相同的功能，处理请求时调用那台服务器都可以，主要起分流作用</span></span></div></li><ul><li><div><font style="font-size: 10pt;"><span style="letter-spacing: 0.2px; orphans: 3; text-indent: 0px; text-transform: none; white-space: normal; widows: 3; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-size: 10pt; color: rgb(51, 51, 51); font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">集群有两个方式：一种是在静态资源集群。另一种是应用程序集群。静态资源集群比较简单。</span></font></div></li></ul><li><div><span style="letter-spacing: 0.2px; orphans: 3; text-indent: 0px; text-transform: none; white-space: normal; widows: 3; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><span style="font-size: 10pt; color: rgb(51, 51, 51); font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">应用程序集群在处理过程中最核心的问题就是</span><span style="background-color: rgb(255, 250, 165); font-size: 10pt; color: rgb(51, 51, 51); font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;-evernote-highlight:true;">Session 同步问题</span></span></div></li><ul><li><div><font style="font-size: 10pt;"><span style="letter-spacing: 0.2px; orphans: 3; text-indent: 0px; text-transform: none; white-space: normal; widows: 3; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-size: 10pt; color: rgb(51, 51, 51); font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">一种是在Session 发生变化后自动同步到其他服务器（Tomcat），另一种就是用一个程序统一管理Session，<span style="font-size: 10pt; color: rgb(51, 51, 51); font-family: &quot;Helvetica Neue&quot;; font-variant-caps: normal; font-variant-ligatures: normal;"> 在</span><span style="letter-spacing: 0.2px; orphans: 3; text-indent: 0px; text-transform: none; white-space: normal; widows: 3; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-size: 10pt; color: rgb(51, 51, 51); font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">应用程序中通过重写Request并覆盖getSession 方法来获取指定服务器中的Session</span></span></font></div></li></ul><li><div><font style="font-size: 10pt;"><span style="letter-spacing: 0.2px; orphans: 3; text-indent: 0px; text-transform: none; white-space: normal; widows: 3; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-size: 10pt; color: rgb(51, 51, 51); font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">还有一个核心的问题就是负载均衡</span></font></div></li><ol><li><div><span style="font-size: 10pt; color: rgb(51, 51, 51); font-family: &quot;Helvetica Neue&quot;;">硬</span><span style="font-size: 10pt; color: rgb(51, 51, 51); font-family: &quot;Helvetica Neue&quot;;">件：</span> <span style="letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-size: 10pt; color: rgb(47, 47, 47); font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">NetScaler、F5、Radware和Array等商用的负载均衡器，性能好，但是价格比较昂贵的</span></div></li><li><div><span style="font-size: 10pt; color: rgb(51, 51, 51); font-family: &quot;Helvetica Neue&quot;;">软件</span></div></li><ul><li><div><span style="font-size: 10pt; color: rgb(51, 51, 51); font-family: &quot;Helvetica Neue&quot;;">LVS(Linux Virtual Server)：最好的软件策略，有备机有主机，无单点问题，国产(阿里章文嵩博士)开源项目，工作在网络四层上</span></div></li><ul><li><div><span style="font-size: 10pt; color: rgb(51, 51, 51); font-family: &quot;Helvetica Neue&quot;;">负载度高，但是功能少，而且对服务器的性能要求高</span></div></li></ul><li><div><span style="font-size: 10pt; color: rgb(51, 51, 51); font-family: &quot;Helvetica Neue&quot;;">Nginx：Ngnix有”单点故障“的问题，如果挂了，会带来很多的麻烦。到了后期Web服务器继续增加，它本身可能会成为系统的瓶颈。nginx最高支持50000个并发连接数，工作在网路七层上</span></div></li><ul><li><div><span style="letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><span style="font-size: 10pt; color: rgb(33, 37, 41); font-family: -apple-system, BlinkMacSystemFont, &quot;Segoe UI&quot;, Roboto, &quot;Helvetica Neue&quot;, Arial, sans-serif, &quot;Apple Color Emoji&quot;, &quot;Segoe UI Emoji&quot;, &quot;Segoe UI Symbol&quot;; font-variant-caps: normal; font-variant-ligatures: normal;">keepalived + nginx。</span></span></div></li><li><div><span style="letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><span style="font-size: 10pt; color: rgb(33, 37, 41); font-family: -apple-system, BlinkMacSystemFont, &quot;Segoe UI&quot;, Roboto, &quot;Helvetica Neue&quot;, Arial, sans-serif, &quot;Apple Color Emoji&quot;, &quot;Segoe UI Emoji&quot;, &quot;Segoe UI Symbol&quot;; font-variant-caps: normal; font-variant-ligatures: normal;">原理就在于做了一层TCP级别的负载均衡，使用VRRP协议，将一组机器（及其IP）组成一个虚拟 路由器，其中这个组的成员使用主从方式，主来承担流量分发任务，当主挂了之后，从挺身而出，承担主的任务，主恢复之后，便恢复 原来的主从模式。</span></span></div></li></ul><li><div><span style="font-size: 10pt; color: rgb(51, 51, 51); font-family: &quot;Helvetica Neue&quot;;">Apache：web服务器第一，但不是最好的负载均衡服务器，工作在网路七层上</span></div></li></ul></ol></ol><li><div><span style="font-size: 10pt; color: rgb(51, 51, 51); font-family: &quot;Helvetica Neue&quot;;">CDN</span></div></li><ol><li><div><span style="letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><span style="font-size: 10pt; color: rgb(79, 79, 79); font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif, SimHei, SimSun; font-variant-caps: normal; font-variant-ligatures: normal;">一种特殊的集群页面缓存服务器</span></span></div></li><li><div><span style="font-size: 10pt; color: rgb(79, 79, 79); font-family: &quot;Helvetica Neue&quot;;">将不同地域的请求分流到最近服务器，如果该服务器没有请求资源的缓存，则请求主服务器</span></div></li></ol><li><div><font style="font-size: 10pt;"><span style="letter-spacing: 0.2px; orphans: 3; text-indent: 0px; text-transform: none; white-space: normal; widows: 3; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-size: 10pt; color: rgb(51, 51, 51); font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">数据库集群或者库表散列</span></font></div></li><ol><li><div><span style="font-size: 10pt; color: rgb(51, 51, 51); font-family: &quot;Helvetica Neue&quot;;">读写分离</span></div></li></ol></ol><li><div><span style="font-size: 13px; color: rgb(51, 51, 51);">实在服务器就是扛不住，</span><span style="color: rgb(51, 51, 51); font-size: 13px;">可以进行限流（漏桶，令牌桶）</span></div></li><ul><li><div><font style="font-size: 14px;"><span style="color: rgb(77, 77, 77); font-family: &quot;PT Serif&quot;, Georgia, Times, &quot;Times New Roman&quot;, serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(248, 248, 248);"><font>漏桶(Leaky Bucket)算法思路很简单,水(请求)先进入到漏桶里,漏桶以一定的速度出水(接口有响应速率),当水流入速度过大会直接溢出(访问频率超过接口响应速率),然后就拒绝请求。</font></span><span style="color: rgb(77, 77, 77); font-family: &quot;PT Serif&quot;, Georgia, Times, &quot;Times New Roman&quot;, serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(248, 248, 248);">因为漏桶的漏出速率是固定的参数,所以,即使网络中不存在资源冲突(没有发生拥塞),漏桶算法也不能使流突发(burst)到端口速率.因此,漏桶算法对于存在突发特性的流量来说缺乏效率.</span></font></div></li><li><div><font style="font-size: 14px;"><span style="color: rgb(77, 77, 77); font-family: &quot;PT Serif&quot;, Georgia, Times, &quot;Times New Roman&quot;, serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(248, 248, 248);">令牌桶算法(Token Bucket)：</span><span style="color: rgb(77, 77, 77); font-family: &quot;PT Serif&quot;, Georgia, Times, &quot;Times New Roman&quot;, serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(248, 248, 248);">随着时间流逝,系统会按恒定1/QPS时间间隔(如果QPS=100,则间隔是10ms)往桶里加入Token(想象和漏洞漏水相反,有个水龙头在不断的加水),如果桶已经满了就不再加了.新请求来临时,会各自拿走一个Token,如果没有Token可拿了就阻塞或者拒绝服务.</span><span style="color: rgb(77, 77, 77); font-family: &quot;PT Serif&quot;, Georgia, Times, &quot;Times New Roman&quot;, serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(248, 248, 248);">令牌桶的另外一个好处是可以方便的改变速度. 一旦需要提高速率,则按需提高放入桶中的令牌的速率. 一般会定时(比如100毫秒)往桶中增加一定数量的令牌, 有些变种算法则实时的计算应该增加的令牌的数量.</span></font></div></li></ul><li><div><font style="font-size: 10pt;"><span style="letter-spacing: 0.2px; orphans: 3; text-indent: 0px; text-transform: none; white-space: normal; widows: 3; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-size: 10pt; color: rgb(51, 51, 51); font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">围绕大数据和高并发这两个问题展开的，解决方案主要分为使用缓存和多资源两种类型。多资源主要指多存储（包括多内存）、多CPU和多网络，对于多资源来说又可以分为单个资源处理一个完整的请求和多个资源合作处理一个请求两种类型，如多存储和多CPU中的集群和分布式，多网络中的CDN和静态资源分离。理解了整个思路之后就抓住了架构演变的本质，而且自己可能还可以设计出更好的架构。</span></font></div></li></ol></ol><div><br/></div><div><br/></div><div><br/></div><ul><li><div>Tips</div></li><ul><li><div><span style="font-size: 16px; color: rgb(64, 64, 64);">系统吞吐量</span></div></li><ul><li><div><span style="color: rgb(64, 64, 64); font-family: -apple-system, system-ui, &quot;Apple Color Emoji&quot;, &quot;Segoe UI Emoji&quot;, &quot;Segoe UI Symbol&quot;, &quot;Segoe UI&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;">并发数： 系统同时处理的request/事务数</span></div></li><li><div><span style="color: rgb(64, 64, 64); font-family: -apple-system, system-ui, &quot;Apple Color Emoji&quot;, &quot;Segoe UI Emoji&quot;, &quot;Segoe UI Symbol&quot;, &quot;Segoe UI&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;">响应时间： 一般取平均响应时间</span></div></li><li><div><span style="color: rgb(64, 64, 64); font-family: -apple-system, system-ui, &quot;Apple Color Emoji&quot;, &quot;Segoe UI Emoji&quot;, &quot;Segoe UI Symbol&quot;, &quot;Segoe UI&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;">QPS（TPS）：每秒钟request/事务 数量</span></div></li><li><div><span style="color: rgb(64, 64, 64); font-family: -apple-system, system-ui, &quot;Apple Color Emoji&quot;, &quot;Segoe UI Emoji&quot;, &quot;Segoe UI Symbol&quot;, &quot;Segoe UI&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;">QPS（TPS）= 并发数/平均响应时间</span></div></li></ul><li><div>常用服务器</div></li><ul><li><div>tomcat： 免费</div></li><li><div>weblogic： 稳定</div></li></ul></ul></ul><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div></div><div><br/></div></body></html>