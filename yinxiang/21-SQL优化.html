<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content="Evernote Mac 9.4.0 (460661)"/><meta name="author" content="1404001663@qq.com"/><meta name="created" content="2018-09-01 03:43:05 +0000"/><meta name="source" content="desktop.win"/><meta name="source-application" content="yinxiang.win32"/><meta name="updated" content="2020-04-27 08:58:33 +0000"/><title>21-SQL优化</title></head><body><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 10pt;">1.MySQL大表优化</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 10pt;">    1.字段         </font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 10pt;">            尽量使用TINYINT、SMALLINT、MEDIUM_INT作为整数类型而非INT，如果非负则加上UNSIGNED</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 10pt;">            <span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;">使用枚举或整数代替字符串类型</span></font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 10pt;">            <span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;">尽可能的使用 varchar</span></font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 10pt;">            尽量使用TIMESTAMP而非DATETIME，</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 10pt;">            <span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;">避免使用NULL字段，很难查询优化且占用额外索引空间</span></font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 10pt;">            用整型来存IP</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 10pt;">        2.索引</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 10pt;">            索引并不是越多越好，要根据查询有针对性的创建，考虑<span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;">在WHERE和ORDER BY命令上涉及的列建立索引</span></font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 10pt;">            应尽量避免在WHERE子句中对字段进行NULL值判断，否则将导致引擎放弃使用索引而进行全表扫描</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 10pt;">            <span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;">不用外键，由程序保证约束  </span></font></span><span style="font-size: 10pt;font-family: Monaco;color: rgb(156, 220, 254);background-color: rgb(255, 250, 165);-evernote-highlight:true;">db_constraint</span><span style="font-size: 10pt;font-family: Monaco;color: rgb(212, 212, 212);background-color: rgb(255, 250, 165);-evernote-highlight:true;">=</span><span style="font-size: 10pt;font-family: Monaco;color: rgb(86, 156, 214);background-color: rgb(255, 250, 165);-evernote-highlight:true;">False</span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 10pt;">            <span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;">尽量不用UNIQUE，由程序保证约束</span></font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 10pt;">        3.查询SQL</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 10pt;">             不做列运算：SELECT id WHERE age + 1 = 10，任何对列的操作都将导致表扫描，</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 10pt;">             sql语句尽可能简单：一条sql只能在一个cpu运算；</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 10pt;"><span>    <span>    <span>     </span></span></span>大语句拆小语句，减少锁时间；一条大sql可以堵死整个库</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 10pt;">             不用SELECT *</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 10pt;">             不用函数和触发器，在应用程序实现</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 10pt;">             少用JOIN</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 10pt;">             <span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;">尽量避免在WHERE子句中使用!=或&lt;&gt;操作符，否则引擎<span style="font-family: Monaco; color: rgb(51, 51, 51); font-size: 10pt;">将</span>放弃使用索引而进行全表扫描</span></font></span></div><div><span style="font-size: 10pt; font-family: Monaco; color: rgb(51, 51, 51);">             </span><span style="font-size: 10pt;background-color: rgb(255, 250, 165);font-family: Monaco;color: rgb(51, 51, 51);-evernote-highlight:true;">OR改写成IN</span><span style="font-size: 10pt;background-color: rgb(255, 250, 165);font-family: Monaco;color: rgb(51, 51, 51);-evernote-highlight:true;">：OR的效率是n级别，IN的效率是log(n)级别，in的个数建议控制在200以内</span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 10pt;">             <span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;">对于连续数值，使用BETWEEN不用IN</span>：</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 10pt;">        4.引擎</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 10pt;">            1. InnoDB</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 10pt;">                1. 在并发度较高的场景下使用InnoDB会提升效率的。</font></span><span style="font-size: 10pt; font-family: Monaco;">它的设计的目标就是处理大数据容量的数据库系统，</span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 10pt;">                4. InnoDB更适合写密集的的表，适合作为线上事物型数据库。</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 10pt;">            2. MyISAM</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 10pt;">                1. </font></span><span style="font-size: 10pt; font-family: Monaco;">如果表的读操作远远多于写操作时，并且不需要事务的支持的。可以将MyIASM作为数据库引擎的首选，</span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 10pt;">                   它强调的是性能，就读取数据而言比InnoDB更快。</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 10pt;">                2. MyISAM更适合读密集的表，适用于ROLAP数据仓库</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 10pt;">        5.系统调优参数</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 10pt;">        6.升级硬件</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 10pt;">        7.读写分离</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 10pt;">            主库写，从库读</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 10pt;">        8.缓存</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 10pt;">            1.mysql内部：缓存区的设置</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 10pt;">            2.数据访问层：对SQL语句做缓存，利用 drf-extensions + Redis进行缓存，减少服务器的访问次数</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 10pt;">            3.web层：页面静态化</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 10pt;">            4.浏览器客户端：客户端缓存</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 10pt;">        9.表拆分</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 10pt;">            1.垂直/水平  拆分</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 10pt;">        10.代理架构</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 10pt;">             通过独立的中间件来统一管理所有数据源和数据分片整合</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 10pt;">        11.选择NoSQL</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 10pt;">2.面试常见</font></span></div><div><font style="font-size: 10pt;"><span style="font-family: Monaco; color: rgb(51, 51, 51);">    </span> <span style="font-family: Monaco; color: rgb(51, 51, 51);">一、表的设计</span></font></div><div><span style="font-family: Monaco; font-size: 10pt;">        架构方向：对数据库性能影响较大的特性少用；应将计算集中在服务层，解放数据库CPU；</span></div><div><span style="font-size: 10pt; font-family: Monaco;">        数据库擅长索引和存储，勿让数据库背负重负</span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 10pt;">       </font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 10pt;">        0、必须使用默认的InnoDB存储引擎--支持事务、行级锁、并发性能好、CPU及内存缓存页优化使得资源利用率高</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 10pt;">        1、表和字段使用中文注释--便于后人理解</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 10pt;">        2、使用默认utf8mb4字符集--标准、万国码、无乱码风险、无需转码</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 10pt;">        3、禁止使用触发器、视图、存储过程和event</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 10pt;">        4、禁止使用外键--外键导致表之间的耦合，update和delete操作都会涉及相关表，影响性能</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 10pt;">        5、禁止存大文件或者照片--在数据库里存储URI</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 10pt;">       </font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 10pt;"> 字段：</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 10pt;">        6、必须把字段定义为NOT NULL并设置默认值--null值需要更多的存储空间；</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 10pt;">        7、禁止使用TEXT/BOLB字段类型--浪费磁盘和内存空间，非必要的大量的大字段查询导致内存命中率降低，影响数据库性能</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 10pt;">       </font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 10pt;"> 索引：</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 10pt;">        8、单表索引控制在5个以内</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 10pt;">        9、联合索引不超过5个字段--超过5个起不到有效过滤数据的效果</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 10pt;">        10、建立组合索引，必须把区分度高的字段放在前边--更加有效的过滤数据</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 10pt;">        11、数据区分度不大的字段不应使用索引--例如：性别只有男，女，每次过滤数据很少</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 10pt;">    二、SQL查询规范：</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 10pt;">        1、禁止使用select *，只获取需要的字段--查询很多无用字段，增加CPU/IO/NET消耗；</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 10pt;">           不能有效的利用覆盖索引；增删字段易出bug</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 10pt;">        2、禁止使用属性的隐式转换select * from customer where phone=123123--会导致全表扫描，不能命中索引</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 10pt;">        3、禁止在where条件上使用函数和计算</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 10pt;">        4、禁止负向查询（NOT != &lt;&gt; !&lt; !&gt; MOT IN NOT LIKE）和%开头的like（前导模糊查询）--会导致全表扫描</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 10pt;">        5、禁止大表使用JOIN查询和子查询--会产生临时表，消耗较多CPU和内存，影响数据库性能</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 10pt;">        6、在属性上进行计算不能命中索引--如 select * from order where YEAR(date) &lt;= '2017'不能命中索引导致全表扫描</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 10pt;">        7、明知道只有一条记录返回，建议加上limit 1</font></span></div></div><div><br/></div></body></html>